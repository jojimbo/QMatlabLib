classdef CriticalScenarioEngine
    %CRITICALSCENARIOENGINE Summary of this class goes here
    %   Detailed explanation goes here
    
    
    properties
        BaseScenarioSetName;
        ScenarioSetName;
        NoOfBatches = 1;
        AraReportDAO;
        SmoothingRule;
    end
    
    methods
        
        function engine = CriticalScenarioEngine(araReportDAO, smoothingRule)
            engine.AraReportDAO = araReportDAO;
            engine.SmoothingRule = smoothingRule;
        end
        
        function Run(obj)
                                   
            if isempty(obj.AraReportDAO)
                throw(MException('CriticalScenarioEngine:Run', 'The ARA report DAO object is not set.'));
            end
            
            if isempty(obj.SmoothingRule)
                throw(MException('CriticalScenarioEngine:Run', 'The smoothing rule object is not set.'));
            end
                        
            
            % load base scenario set data.
            [baseModelFile baseScenarioSet stoValues subRisks] = obj.LoadBaseScenarioSet();
            
            % load ARA report data.
            araReportData = obj.AraReportDAO.Load();
            if isempty(araReportData)
                disp('No ARA report data are loaded.');
            end
            
            nNodes = size(araReportData, 1);
            for i = 1:nNodes                
                weightings = araReportData{i, 3}';
                scenIds = araReportData{i, 2};       
                scenData = stoValues(scenIds, :);
                % smooth data.
                araReportData(i, 4) = {obj.SmoothingRule.Smooth(scenData, weightings);};
            end
            
            % save results.
            obj.SaveScenarioSet(araReportData, baseScenarioSet, baseModelFile, subRisks);
            
        end
    end
    
    methods(Access=private)
        
        % load base scenario set data.
        function [modelFile scenarioSet stoValues subRisks] = LoadBaseScenarioSet(obj)            
            disp(['Reading base scenario set ' baseScenSetName '.\n']);  
            
            if isempty(obj.BaseScenarioSetName)
                throw(MException('CriticalScenarioEngine:LoadBaseScenarioSet', 'The base scenario set name is not set.'));
            end
            
            import prursg.Xml.*;           
            % establish connection to database
            db = prursg.Db.DbFacade();    
            [modelFile scenarioSet stoValues riskIds stochasticScenarioId job nBatches] = db.readScenarioSet(obj.BaseScenarioSetName, obj.NoOfBatches);        

            % remove no risk scenario data.
            if ~isempty(scenarioSet.noRiskScenario)
                stoValues(1, :) = [];
            end
            
            subRisks = prursg.Util.JobUtil.getSubRisks(modelFile.riskDrivers, baseScenario.expandedUniverse);            
            
            delete (db);
        end
        
        % save se
        function SaveScenarioSet(obj, araReportData, baseScenarioSet, modelFile, subRisks)
            
            if isempty(obj.ScenarioSetName)
                throw(MException('CriticalScenarioEngine:SaveScenarioSet', 'The scenario set name is not set.'));
            end                     
                        
            stochasticScenarios = CreateScenariosFromAraReports(araReportData, baseScenarioSet.getBaseScenario().date);      
            
            scenarioTypeKey = int32(prursg.Engine.ScenarioType.CriticalScenario);
            % update model file.
            modelFile.scenario_type_key = scenarioTypeKey;
            modelFile.modelFileDOM.getDocumentElement().getElementsByTagName('scenario_type_key').item(0).getFirstChild().setData(num2str(scenarioTypeKey));
            
            % update scenario set name.
            scenarioSet.name = scenSetName;
            
            import prursg.Xml.*;           
            % establish connection to database
            db = prursg.Db.DbFacade();  
            jobId = db.storeJob(modelFile, now(), now());
            
            [scenarioSetId scenarioId noRiskScenarioId] = db.storeScenarioSet( ...
                jobId, scenarioSet, modelFile.scenario_set_type, ...
                scenarioTypeKey, stochasticScenarios, 1, modelFile.riskDrivers);


            assert(numel(scenarioId) == numel(stochasticScenarios));    
            data = araReportData(find(cell2mat(cellfun(@(x){~isempty(x)}, araReportData(:, 2)))), :);
            mcNumber = 0;
            for i = 1: numel(scenarioId)
                simulationOutputs = data{i, 4};                 
                if ~isempty(simulationOutputs)
                    simulationOutputs = mat2cell(simulationOutputs, size(simulationOutputs, 1), subRisks(:, 1)');
                    db.storeScenarioChunk( ...
                    mcNumber, ...
                    modelFile.riskDrivers, scenarioSetId, scenarioId(i), ...
                    simulationOutputs ...
                    );
                    mcNumber = mcNumber + size(simulationOutputs{1}, 1);
                end
            end       
            
        end   
        
        % create scenario objects based on the ARA report data.
        % data - ARA report data.
        % date - The last deterministc date of the base scenario set.
        function scenarios = CreateScenariosFromAraReport(obj, data, date)
            
            scenarios = [];
            if ~isempty(nodeNames)
                for i = 1:size(data, 1)
                    if ~isempty(data{i, 4}) % check whether or not the smoothed data is contained.
                        scenario = prursg.Engine.Scenario();
                        scenario.name = data{i, 1};
                        scenario.number = i;
                        scenario.date = date;
                        scenario.scen_step = 0;

                        scenarios = [scenarios scenario];
                    end
                end
            end        
        end
        
    end    
end

